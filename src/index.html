<!-- [UNCHANGED HTML HEAD & STYLES ABOVE THIS LINE] -->
<!-- Just replace the JS and add one new button below the history section -->

<!-- Add this button under the history section in HTML -->
<div style="text-align: right; margin-top: 10px;">
    <button id="clear-history">üóëÔ∏è Clear History</button>
</div>

<!-- Add/Update this JS block at the bottom of your <script> tag -->
<script>
    const modeToggle = document.getElementById('mode-toggle');
    const userPrompt = document.getElementById('user-prompt');
    const jsonPreview = document.getElementById('json-preview');
    const historyDiv = document.getElementById('history');
    const clearHistoryBtn = document.getElementById('clear-history');

    modeToggle.addEventListener('change', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    });

    // Preserve theme
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        modeToggle.checked = true;
    }

    // JSON preview
    userPrompt.addEventListener('input', () => {
        const preview = userPrompt.value.trim();
        jsonPreview.textContent = preview
            ? `{\n  "user_prompt": "${preview.replace(/"/g, '\\"')}"\n}`
            : 'Waiting for input...';
    });

    // Load saved history
    function loadHistory() {
        const saved = JSON.parse(localStorage.getItem('commandHistory') || '[]');
        saved.forEach(entry => addHistoryEntry(entry.text, entry.time, false));
    }

    function addHistoryEntry(text, time = new Date().toLocaleTimeString(), save = true) {
        const entry = document.createElement('div');
        entry.className = 'history-entry';
        entry.innerHTML = `<span class="timestamp">[${time}]</span> ${text}`;
        historyDiv.prepend(entry);

        if (save) {
            const saved = JSON.parse(localStorage.getItem('commandHistory') || '[]');
            saved.unshift({ text, time });
            localStorage.setItem('commandHistory', JSON.stringify(saved));
        }
    }

    // Clear history
    clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Clear command history?')) {
            localStorage.removeItem('commandHistory');
            historyDiv.innerHTML = '';
        }
    });

    // Send command
    document.getElementById('send-button').addEventListener('click', async () => {
        const systemPrompt = document.getElementById('system-prompt').value.trim();
        const userPromptVal = userPrompt.value.trim();
        const functionUrl = document.getElementById('function-url').value;
        const responseDiv = document.getElementById('response');
        const statusDiv = document.getElementById('status');

        if (!userPromptVal) return alert("User prompt is required.");

        responseDiv.textContent = 'Sending request...';
        statusDiv.className = 'status';
        statusDiv.textContent = '';

        try {
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_prompt: userPromptVal,
                    ...(systemPrompt ? { system_prompt: systemPrompt } : {})
                })
            });

            const text = await response.text();
            responseDiv.textContent = text;

            if (response.ok) {
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Command sent successfully!';
                addHistoryEntry(userPromptVal);
            } else {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
        } catch (err) {
            responseDiv.textContent = 'Request failed';
            statusDiv.className = 'status error';
            statusDiv.innerHTML = `
                <strong>Error: ${err.message}</strong><br>
                <ul>
                    <li>Check Azure Function URL</li>
                    <li>Ensure Function App is running</li>
                    <li>Verify CORS settings</li>
                </ul>
            `;
        }
    });

    // Load history on page load
    loadHistory();
</script>
